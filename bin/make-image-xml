#!c:/Perl64/bin/perl
#-*-perl-*-

use strict;
use lib './lib';

@ARGV == 1 or die "Missing directory";



my ($dir) = @ARGV;

my ($date) = ($dir =~/(20\d\d-\d\d-\d\d)/);
defined $date or die "Unable to get date from '$dir'";

print <<EOT;
<images date="$date"
        in-chronological-order="true"
        trip-id="1"
>
EOT
my @files = glob "$dir/*";
foreach my $file (@files) {
    $file =~ s,.*/,,;
    next if $file =~ /-(enl|ENL)\./;
    next if $file =~ /images.xml$/;
    next if $file =~ /~$/;

    copy_to_enl($dir, $file);

    next if $file =~ /~$/;
	print <<EOT;
<image filename="$file"
	rating="100"
	type="picture"
	photographer="Gabriel Deal"
/>
EOT
}
print "</images>\n";

sub copy_to_enl {
    my ($dir, $file) = @_;

    my ($name, $ext) = ($file =~ /(.*)\.(jpg|gif|jpeg|png)/i);
    die "Can't parse filename '$file'" unless defined $name;

    my_system("cp", "$dir/$file", "$dir/$name-enl.$ext") == 0
        or die "Failed to copy $file";
}

sub my_system {
    my (@command) = @_;
    return system @command;
}

## The resize quality is poor
#
# my $enl_dir = "$dir/tmp-enl";
# my $small_dir = "$dir/tmp-small";
# 
# system "mkdir $enl_dir";
# system "mkdir $small_dir";
# 
# system "jpegsize.exe -ratio 30 -srcdir $dir -destdir $enl_dir";
# system "jpegsize.exe -ratio 11 -srcdir $dir -destdir $small_dir";
# foreach my $file (@files) {
#     my $resized_file = "${file}_s.jpg";
# 
#     my $enl_file = $file;
#     $enl_file =~ s/(\.\S+)$/-enl$1/;
# 
#     my $small_file = $file;
# 
#     system "mv $enl_dir/$resized_file $dir/$enl_file";
#     system "mv $small_dir/$resized_file $dir/$small_file";
# }
# system "rmdir $enl_dir";
# system "rmdir $small_dir";
# 
